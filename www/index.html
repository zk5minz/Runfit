// Cordova 앱 초기화
document.addEventListener('deviceready', onDeviceReady, false);

// 글로벌 변수들
let isRunning = false;
let startTime = null;
let runningTimer = null;
let currentPosition = null;
let watchId = null;
let runningData = {
    time: 0,
    distance: 0,
    pace: 0,
    calories: 0
};

function onDeviceReady() {
    console.log('Device is ready');
    
    // UI 상태 변경
    document.querySelector('.listening').style.display = 'none';
    document.querySelector('.received').style.display = 'block';
    
    // 3초 후 상태 표시 숨기기
    setTimeout(() => {
        document.getElementById('deviceStatus').style.display = 'none';
    }, 3000);
    
    // 앱 초기화
    initializeApp();
}

// 앱 초기화 함수
function initializeApp() {
    console.log('Running app initialized');
    
    // UI 이벤트 리스너 등록
    setupEventListeners();
    
    // 시각적 효과 초기화
    createFloatingCircles();
    createParticles();
    addCardEffects();
    
    // 스크롤 이벤트
    window.addEventListener('scroll', handleScroll);
}

// 이벤트 리스너 설정
function setupEventListeners() {
    // 러닝 관련 버튼들
    document.getElementById('startRunning').addEventListener('click', startRunning);
    document.getElementById('stopRunning').addEventListener('click', stopRunning);
    document.getElementById('pauseRunning').addEventListener('click', pauseRunning);
    document.getElementById('viewHistory').addEventListener('click', viewHistory);
    
    // 네비게이션 링크들
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // 버튼 리플 효과
    document.querySelectorAll('.btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            const ripple = document.createElement('span');
            ripple.style.position = 'absolute';
            ripple.style.width = '0';
            ripple.style.height = '0';
            ripple.style.borderRadius = '50%';
            ripple.style.background = 'rgba(255, 255, 255, 0.5)';
            ripple.style.transform = 'scale(0)';
            ripple.style.animation = 'ripple 0.6s linear';
            
            this.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        });
    });

    // 앱 일시정지/재개 이벤트
    document.addEventListener('pause', onPause, false);
    document.addEventListener('resume', onResume, false);
}

// 러닝 시작
function startRunning() {
    console.log('Starting running session');
    
    if (navigator.geolocation) {
        // GPS 권한 요청 및 위치 추적 시작
        navigator.geolocation.getCurrentPosition(
            function(position) {
                console.log('GPS 초기 위치 획득 성공');
                currentPosition = position;
                
                // 러닝 화면으로 전환
                showRunningScreen();
                
                // 러닝 세션 시작
                isRunning = true;
                startTime = new Date().getTime();
                
                // 위치 추적 시작
                startLocationTracking();
                
                // 타이머 시작
                startTimer();
                
            },
            function(error) {
                console.log('GPS 오류:', error.message);
                alert('GPS를 사용할 수 없습니다. 위치 권한을 확인해주세요.');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000
            }
        );
    } else {
        alert('이 디바이스는 GPS를 지원하지 않습니다.');
    }
}

// 러닝 화면 표시
function showRunningScreen() {
    document.getElementById('runningScreen').style.display = 'flex';
    document.querySelector('.hero').style.display = 'none';
    document.querySelector('.features').style.display = 'none';
}

// 메인 화면으로 돌아가기
function showMainScreen() {
    document.getElementById('runningScreen').style.display = 'none';
    document.querySelector('.hero').style.display = 'flex';
    document.querySelector('.features').style.display = 'block';
}

// 위치 추적 시작
function startLocationTracking() {
    if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(
            function(position) {
                updateRunningData(position);
            },
            function(error) {
                console.log('위치 추적 오류:', error.message);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 1000
            }
        );
    }
}

// 러닝 데이터 업데이트
function updateRunningData(position) {
    if (!currentPosition) return;
    
    // 거리 계산 (하버사인 공식 사용)
    const distance = calculateDistance(
        currentPosition.coords.latitude,
        currentPosition.coords.longitude,
        position.coords.latitude,
        position.coords.longitude
    );
    
    runningData.distance += distance;
    currentPosition = position;
    
    // 페이스 계산 (분/km)
    if (runningData.distance > 0 && runningData.time > 0) {
        runningData.pace = (runningData.time / 60) / runningData.distance;
    }
    
    // 칼로리 계산 (대략적인 공식: 거리(km) * 체중(kg) * 1.036)
    // 여기서는 평균 체중 70kg로 가정
    runningData.calories = Math.round(runningData.distance * 70 * 1.036);
    
    // UI 업데이트
    updateRunningUI();
}

// 거리 계산 함수 (하버사인 공식)
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // 지구 반지름 (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// 타이머 시작
function startTimer() {
    runningTimer = setInterval(() => {
        if (isRunning) {
            runningData.time = Math.floor((new Date().getTime() - startTime) / 1000);
            updateRunningUI();
        }
    }, 1000);
}

// 러닝 UI 업데이트
function updateRunningUI() {
    // 시간 포맷팅 (HH:MM:SS)
    const hours = Math.floor(runningData.time / 3600);
    const minutes = Math.floor((runningData.time % 3600) / 60);
    const seconds = runningData.time % 60;
    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // 페이스 포맷팅 (M'SS"/km)
    const paceMinutes = Math.floor(runningData.pace);
    const paceSeconds = Math.floor((runningData.pace - paceMinutes) * 60);
    const paceString = `${paceMinutes}'${paceSeconds.toString().padStart(2, '0')}"/km`;
    
    // UI 요소들 업데이트
    document.getElementById('runningTime').textContent = timeString;
    document.getElementById('runningDistance').textContent = `${runningData.distance.toFixed(2)} km`;
    document.getElementById('runningPace').textContent = paceString;
    document.getElementById('runningCalories').textContent = `${runningData.calories} kcal`;
}

// 러닝 정지
function stopRunning() {
    console.log('Stopping running session');
    
    isRunning = false;
    
    // 타이머 정지
    if (runningTimer) {
        clearInterval(runningTimer);
        runningTimer = null;
    }
    
    // 위치 추적 정지
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
    
    // 러닝 데이터 저장
    saveRunningSession();
    
    // 메인 화면으로 돌아가기
    showMainScreen();
    
    // 데이터 초기화
    resetRunningData();
    
    alert(`러닝 완료!\n시간: ${document.getElementById('runningTime').textContent}\n거리: ${document.getElementById('runningDistance').textContent}\n칼로리: ${document.getElementById('runningCalories').textContent}`);
}

// 러닝 일시정지/재개
function pauseRunning() {
    const pauseBtn = document.getElementById('pauseRunning');
    
    if (isRunning) {
        // 일시정지
        isRunning = false;
        pauseBtn.textContent = '재개';
        pauseBtn.className = 'btn btn-primary';
        console.log('Running paused');
    } else {
        // 재개
        isRunning = true;
        startTime = new Date().getTime() - (runningData.time * 1000);
        pauseBtn.textContent = '일시정지';
        pauseBtn.className = 'btn btn-secondary';
        console.log('Running resumed');
    }
}

// 러닝 데이터 초기화
function resetRunningData() {
    runningData = {
        time: 0,
        distance: 0,
        pace: 0,
        calories: 0
    };
    currentPosition = null;
    startTime = null;
}

// 러닝 세션 저장 (로컬 스토리지 대신 메모리에 저장)
let runningSessions = [];

function saveRunningSession() {
    const session = {
        id: new Date().getTime(),
        date: new Date().toISOString(),
        time: runningData.time,
        distance: runningData.distance,
        pace: runningData.pace,
        calories: runningData.calories
    };
    
    runningSessions.push(session);
    console.log('러닝 세션 저장됨:', session);
}

// 기록 보기
function viewHistory() {
    if (runningSessions.length === 0) {
        alert('저장된 러닝 기록이 없습니다.');
        return;
    }
    
    let historyText = '러닝 기록:\n\n';
    runningSessions.forEach((session, index) => {
        const date = new Date(session.date).toLocaleDateString('ko-KR');
        const time = formatTime(session.time);
        historyText += `${index + 1}. ${date}\n`;
        historyText += `   시간: ${time}\n`;
        historyText += `   거리: ${session.distance.toFixed(2)}km\n`;
        historyText += `   칼로리: ${session.calories}kcal\n\n`;
    });
    
    alert(historyText);
}

// 시간 포맷팅 함수
function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// 떠다니는 원들 생성
function createFloatingCircles() {
    const container = document.getElementById('circles');
    const numberOfCircles = 15;

    for (let i = 0; i < numberOfCircles; i++) {
        const circle = document.createElement('div');
        circle.className = 'circle';
        
        const size = Math.random() * 100 + 20;
        circle.style.width = `${size}px`;
        circle.style.height = `${size}px`;
        circle.style.left = `${Math.random() * 100}%`;
        circle.style.animationDelay = `${Math.random() * 20}s`;
        circle.style.animationDuration = `${Math.random() * 20 + 15}s`;
        
        container.appendChild(circle);
    }
}

// 파티클 효과
function createParticles() {
    setInterval(() => {
        if (Math.random() > 0.7) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = `${Math.random() * 100}%`;
            document.body.appendChild(particle);

            setTimeout(() => {
                particle.remove();
            }, 15000);
        }
    }, 300);
}

// 스크롤 효과
function handleScroll() {
    const header = document.querySelector('header');
    const scrolled = window.pageYOffset;
    
    if (scrolled > 100) {
        header.style.background = 'rgba(255, 255, 255, 0.15)';
    } else {
        header.style.background = 'rgba(255, 255, 255, 0.1)';
    }
}

// 카드 호버 효과
function addCardEffects() {
    const cards = document.querySelectorAll('.feature-card');
    
    cards.forEach(card => {
        card.addEventListener('mouseenter', () => {
            card.style.transform = 'translateY(-10px) scale(1.02)';
        });
        
        card.addEventListener('mouseleave', () => {
            card.style.transform = 'translateY(0) scale(1)';
        });
        
        // 카드 클릭 이벤트
        card.addEventListener('click', () => {
            const feature = card.getAttribute('data-feature');
            handleFeatureClick(feature);
        });
    });
}

// 기능 카드 클릭 처리
function handleFeatureClick(feature) {
    let message = '';
    
    switch(feature) {
        case 'gps':
            message = 'GPS 트래킹 기능:\n- 실시간 위치 추적\n- 경로 기록\n- 정확한 거리 측정';
            break;
        case 'distance':
            message = '거리 측정 기능:\n- 실시간 거리 계산\n- 누적 거리 표시\n- 목표 거리 설정';
            break;
        case 'time':
            message = '시간 & 페이스 기능:\n- 실시간 시간 측정\n- 현재/평균 페이스 계산\n- 랩 타임 기록';
            break;
        case 'calories':
            message = '칼로리 계산 기능:\n- 실시간 칼로리 소모량\n- 개인 정보 기반 계산\n- 목표 칼로리 설정';
            break;
        case 'heartrate':
            message = '심박수 모니터링:\n- 실시간 심박수 측정\n- 운동 강도 분석\n- 심박수 존 표시';
            break;
        case 'history':
            message = '기록 관리 기능:\n- 모든 운동 기록 저장\n- 통계 및 분석\n- 진행 상황 추적';
            break;
        default:
            message = '더 많은 기능이 준비되어 있습니다!';
    }
    
    alert(message);
}

// 앱 일시정지 처리
function onPause() {
    console.log('앱이 일시정지됨');
    
    // 러닝 중이면 자동으로 일시정지
    if (isRunning) {
        pauseRunning();
    }
}

// 앱 재개 처리
function onResume() {
    console.log('앱이 재개됨');
    
    // 위치 추적이 활성화되어 있으면 재시작
    if (watchId !== null) {
        startLocationTracking();
    }
}

// DOM이 로드된 후 실행 (웹 환경에서의 폴백)
document.addEventListener('DOMContentLoaded', () => {
    // Cordova 환경이 아닌 경우 직접 초기화
    if (!window.cordova) {
        console.log('웹 환경에서 실행 중');
        setTimeout(() => {
            initializeApp();
            document.querySelector('.listening').style.display = 'none';
            document.querySelector('.received').style.display = 'block';
            setTimeout(() => {
                document.getElementById('deviceStatus').style.display = 'none';
            }, 3000);
        }, 1000);
    }
});

// 백 버튼 처리 (Android)
document.addEventListener("backbutton", function(e) {
    // 러닝 중이면 확인 다이얼로그
    if (isRunning) {
        if (confirm('러닝을 종료하시겠습니까?')) {
            stopRunning();
        }
        e.preventDefault();
        return false;
    }
    
    // 러닝 화면에서는 메인으로 돌아가기
    if (document.getElementById('runningScreen').style.display !== 'none') {
        showMainScreen();
        e.preventDefault();
        return false;
    }
    
    // 메인 화면에서는 앱 종료 확인
    if (confirm('앱을 종료하시겠습니까?')) {
        navigator.app.exitApp();
    }
    e.preventDefault();
    return false;
}, false);

// 메뉴 버튼 처리 (Android)
document.addEventListener("menubutton", function(e) {
    // 설정 메뉴 표시 또는 다른 액션
    alert('메뉴 기능은 준비 중입니다.');
    e.preventDefault();
}, false);
    // Cordova 앱 초기화
document.addEventListener('deviceready', onDeviceReady, false);

function onDeviceReady() {
    // 디바이스가 준비되었을 때 실행
    console.log('Device is ready');
    
    // UI 상태 변경
    document.querySelector('.listening').style.display = 'none';
    document.querySelector('.received').style.display = 'block';
    
    // 여기에 러닝 앱 기능들을 추가할 수 있습니다
    initializeRunningApp();
}

// 러닝 앱 초기화 함수
function initializeRunningApp() {
    console.log('Running app initialized');
    
    // GPS 위치 추적 시작
    startLocationTracking();
    
    // UI 이벤트 리스너 등록
    setupEventListeners();
}

// GPS 위치 추적
function startLocationTracking() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                console.log('현재 위치:', position.coords.latitude, position.coords.longitude);
                // 위치 정보 처리
            },
            function(error) {
                console.log('위치 정보 오류:', error.message);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }
}

// 이벤트 리스너 설정
function setupEventListeners() {
    // 앱 일시정지/재개 이벤트
    document.addEventListener('pause', onPause, false);
    document.addEventListener('resume', onResume, false);
}

function onPause() {
    console.log('앱이 일시정지됨');
}

function onResume() {
    console.log('앱이 재개됨');
}
