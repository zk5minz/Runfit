name: Build RunFit Android App
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ“± Accept Android SDK Licenses
      run: yes | sdkmanager --licenses
      
    - name: ğŸ”§ Install Cordova CLI
      run: npm install -g cordova@latest
      
    - name: ğŸ—ï¸ Check and Initialize Cordova Project
      run: |
        echo "=== í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸ ==="
        ls -la
        
        if [ ! -f "config.xml" ]; then
          echo "config.xmlì´ ì—†ìŠµë‹ˆë‹¤. Cordova í”„ë¡œì íŠ¸ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤."
          cordova create temp_app com.runfit.app RunFit
          cp -r temp_app/* .
          rm -rf temp_app
        else
          echo "ê¸°ì¡´ Cordova í”„ë¡œì íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
        fi
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        if [ -f "package.json" ]; then
          npm install
        else
          echo "package.jsonì´ ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤."
        fi
        
    - name: ğŸ—ï¸ Add Android Platform
      run: |
        if ! cordova platform list | grep -q "android"; then
          cordova platform add android
        else
          echo "Android í”Œë«í¼ì´ ì´ë¯¸ ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
        fi
      
    - name: ğŸ”Œ Install Essential Plugins
      run: |
        cordova plugin add cordova-plugin-whitelist || echo "whitelist í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ì‹¤íŒ¨"
        cordova plugin add cordova-plugin-device || echo "device í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ì‹¤íŒ¨"
        cordova plugin add cordova-plugin-statusbar || echo "statusbar í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ì‹¤íŒ¨"
        
    - name: ğŸ”¨ Build Debug APK
      run: |
        echo "Debug APK ë¹Œë“œ ì‹œì‘..."
        cordova build android --debug
        
    - name: ğŸ”¨ Build Release APK
      run: |
        echo "Release APK ë¹Œë“œ ì‹œì‘..."
        cordova build android --release
        
    - name: ğŸ“ Find and List APK Files
      run: |
        echo "=== APK íŒŒì¼ ê²€ìƒ‰ ==="
        find . -name "*.apk" -type f
        
    - name: ğŸ“¤ Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: RunFit-debug-apk
        path: |
          platforms/android/app/build/outputs/apk/debug/*.apk
        retention-days: 30
        if-no-files-found: warn
        
    - name: ğŸ“¤ Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: RunFit-release-apk
        path: |
          platforms/android/app/build/outputs/apk/release/*.apk
        retention-days: 30
        if-no-files-found: warn
        
    - name: ğŸ“‹ Show Build Results
      run: |
        echo "âœ… ë¹Œë“œ ì™„ë£Œ!"
        echo "ğŸ—“ï¸ ë¹Œë“œ ì‹œê°„: $(date)"
        echo ""
        echo "ğŸ“ ìƒì„±ëœ APK íŒŒì¼ë“¤:"
        find . -name "*.apk" -type f -exec ls -lh {} \;
